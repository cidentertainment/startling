#!/usr/bin/env ruby

class BranchChanges
  def initialize(filepath)
    @filepath = filepath
  end

  def story_ids
    @story_ids ||= parse_story_ids
  end

  private

  attr_reader :filepath

  def changes
    File.readlines(full_path)
  end

  def full_path
    File.join(root_path, filepath)
  end

  def root_path
    @root_path ||= %x[git rev-parse --show-toplevel].chomp
  end

  def parse_story_ids
    ids = changes.map { |change| parse_story_id(change)  }
    ids.compact.reject(&:empty?)
  end

  def parse_story_id(change_line)
    change_line[%r(story/show/(\d+)), 1]
  end
end

changes = BranchChanges.new('BRANCH_CHANGES.md')
changes.story_ids.each { |id| puts id }
